---
title: "Lab 4: Contrasts, Estimation, and Power Analysis"
subtitle: "FANR 6750: Experimental Methods in Forestry and Natural Resources Research"
author: "Fall 2021"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{lab04_contrasts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE, message = FALSE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(kableExtra)
library(FANR6750)
library(WILD6900)
data("sawData")
```

# Today's topics

1) Contrasts

2) Estimation

3) Power analysis

# Contrasts

## Chain saw data

```{r, eval = FALSE}
library(FANR6750)
data("sawData")
head(sawData)
```

```{r echo = FALSE}
knitr::kable(head(sawData), format = 'html')
```

## Questions

Suppose we want to make 3 *a priori* comparisons:  

1) Groups A&D vs B&C  

2) Groups A vs D  

3) Groups B vs C  

```{r echo = FALSE}
contrasts <- data.frame(col1 =c("1", "2", "3"),
                        Comparison = c("AD vs BC", "A vs D", "B vs C"),
                        H0 <- c('\\(\\frac{\\mu_A + \\mu_D}{2} - \\frac{\\mu_B + \\mu_C}{2} = 0\\)',
                                '\\(\\mu_A - \\mu_D = 0\\)',
                                '\\(\\mu_B - \\mu_C = 0\\)'))

contrasts %>%
  kable(align = c("c", "l", "c"), 
        col.names = c("", "Comparison", "Null hypothesis"),
          booktabs = TRUE, escape = FALSE, format = "html") %>%
    kable_styling(bootstrap_options = c("condensed"), 
                full_width = FALSE, font_size = 16) 
```

## Constructing contrasts in R

### Coefficients

```{r}
ADvBC <- c(1/2, -1/2, -1/2, 1/2)
AvD <- c(1, 0, 0, -1)
BvC <- c(0, 1, -1, 0)
```

### Are they orthogonal?

**Step 1**: sum of coefficients is 0, for each contrast.

```{r}
all(sum(ADvBC) == 0, sum(AvD) == 0, sum(BvC) == 0)
```

***

`all()` tests whether all its arguments evaluate to TRUE  

***

**Step 2**: pairwise dot products are all equal to 0.

```{r}
all(sum(ADvBC * AvD) == 0,
    sum(ADvBC * BvC) == 0,
    sum(AvD * BvC) == 0)
```

**Step 2 (alternate method)**: pairwise dot products are all equal to 0.

Try the %*% operator:

```{r}
ADvBC %*% AvD
```

***
When the operands are vectors, `%*%` does the dot product  

***

### Put the contrasts into a matrix

To use contrasts in `R`, each set of coefficients must be formatted as a column in a matrix.  

We can use `cbind()` for this:

```{r}
(contrast.mat <- cbind(ADvBC, AvD, BvC))
```

## Contrasts

#### Fit the model with contrasts

```{r}
aov.out <- aov(y ~ Brand, data=sawData,
               contrasts=list(Brand=contrast.mat))
```

#### Now partition the sum-of-squares with `split=` argument:

```{r}
summary(aov.out, 
        split = list(Brand = c("ADvBC" = 1, 
                               "AvD" = 2, 
                               "BvC" = 3)))
```

## ANOVA without contrasts

#### $\large F_{3, 16}$

```{r echo = FALSE, fig.align="c", fig.width=7, fig.height=5}
x <- seq(from = 0, to = 4, length.out = 400)

f <- data.frame(F = x,
                pdf = df(x = x, df1 = 3, df2 = 16))

p <- qf(0.95, 3, 16)

ggplot(f, aes(x = F, y = pdf)) +
  geom_path() +
  scale_y_continuous("Probability density", limits = c(0, 0.8)) +
  geom_vline(xintercept = p, color = WILD6900_colors$value[WILD6900_colors$name == "warning"]) +
  geom_vline(xintercept = 3.56, linetype = "longdash",
             color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) +
  annotate("text", label = "p = 0.95", hjust = 1,
           x = p - 0.1, y = 0.79, size = 6,
           color = WILD6900_colors$value[WILD6900_colors$name == "warning"]) +
  annotate("text", label = "Brand", x = 3.66, y = 0.79, size = 6, hjust = 0,
           color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) 
```

## ANOVA with contrasts

#### $\large F_{1, 16}$

```{r echo = FALSE, fig.align="c", fig.width=7, fig.height=5}
x <- seq(from = 0, to = 10, length.out = 400)

f <- data.frame(F = x,
                pdf = df(x = x, df1 = 1, df2 = 16))

p <- qf(0.95, 1, 16)

ggplot(f, aes(x = F, y = pdf)) +
  geom_path() +
  scale_y_continuous("Probability density", limits = c(0, 1.25)) +
  geom_vline(xintercept = p, color = WILD6900_colors$value[WILD6900_colors$name == "warning"]) +
  geom_vline(xintercept = 9.68, linetype = "longdash",
             color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) +
  geom_vline(xintercept = 0.1, linetype = "longdash",
             color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) +
  geom_vline(xintercept = 0.89, linetype = "longdash",
             color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) +
  annotate("text", label = "p = 0.95", hjust = 1,
           x = p - 0.1, y = 1.24, size = 6,
           color = WILD6900_colors$value[WILD6900_colors$name == "warning"]) +
  annotate("text", label = "AvD", x = 0.2, y = 1.24, size = 4, hjust = 0,
           color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) +
    annotate("text", label = "BvC", x = 0.99, y = 1.24, size = 4, hjust = 0,
           color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) +
      annotate("text", label = "ADvBC", x = 9.58, y = 1.24, size = 4, hjust = 1,
           color = WILD6900_colors$value[WILD6900_colors$name == "primary"]) 
```

## Difference in means for each contrast

#### Group means

```{r}
library(dplyr)
(group.means <- sawData %>% 
                group_by(Brand) %>%
                 summarise(mu = mean(y)))
```

#### Difference in means for A vs D

```{r}
group.means$mu[1] - group.means$mu[4]
```

#### Difference in means for AD vs BC

```{r}
mean(group.means$mu[c(1,4)]) - mean(group.means$mu[2:3])
```

## Standard errors for each contrast

#### SE for A vs D

```{r}
se.contrast(aov.out, 
            contrast.obj = list(Brand == "A", Brand == "D"), 
            data = sawData)
```

#### SE for AD vs BC

```{r}
se.contrast(aov.out,
            contrast.obj = list(Brand %in% c("A","D"), Brand %in% c("B","C")), 
            data = sawData)
```

***

The `%in%` function returns `TRUE` for any elements of the first vector that match an element in the second vector and `FALSE` otherwise   

***

# Estimation

## Estimating confidence intervals

In an ANOVA context, confidence intervals can be constructed using the equation:

$$CI = Point\; estimate \pm t_{\alpha/2,a(n−1)}\times SE$$
As usual, the hard part is computing the SE^[See page 300 of Dowdy et al.]

## Confidence intervals from one-way ANOVA

#### SE’s for the effect sizes ($\alpha$’s)

```{r}
(effects.SE <- model.tables(aov.out, type="effects", se=TRUE))
```

#### Extract the $\alpha$’s and the SEs

```{r}
# str(effects.SE)
alpha.i <- as.numeric(effects.SE$tables$Brand)
SE <- as.numeric(effects.SE$se)
```

#### Compute confidence intervals

```{r}
tc <- qt(0.975, 4 * (5 - 1))
lowerCI <- alpha.i - tc * SE
upperCI <- alpha.i + tc * SE
```

## Plot effects and CIs

#### Put results into a data frame

```{r}
CI <- data.frame(Brand = c("A", "B", "C", "D"),
                 effect.size = alpha.i, 
                 SE, 
                 lowerCI, 
                 upperCI)
head(CI)
```

#### And plot:

```{r fig.align="c", fig.width=7, fig.height=5}
ggplot(CI, aes(x = Brand, y = effect.size)) +
  geom_hline(yintercept = 0, linetype = "longdash", color = "grey50") +
  geom_errorbar(aes(ymin = lowerCI, ymax = upperCI), width = 0) +
  geom_point() +
  scale_y_continuous("Effect size")

```

# Power analysis

## Statistical Power

#### Errors:

- Type I: the null hypothesis is true, but you reject it  

- Type II: the null hypothesis is false, but you fail to reject it  

- $\alpha = Pr(Type\;I\;error)$  

- $\beta = Pr(Type\;II\;error)$  

> Power = Pr(rejecting a false null) = $1 − \beta$  

In `R` functions `power.t.test()` and `power.anova.test()`, you provide all but one of the "ingredients" for the hypothesis test and determination of power. Then the missing ingredient is estimated.

## Power analysis for a 2-sample t-test

```{r}
power.t.test(n = NULL, 
             delta = 3, 
             sd = 2, 
             sig.level = 0.05, 
             power = 0.8)
```

## Power analysis for one-way ANOVA

```{r}
power.anova.test(groups = 4, 
                 n = 5, 
                 between.var = 360.0,
                 within.var = 101.2, 
                 power = NULL)
```

# Assignment

Researchers wish to know if food supplementation affects the growth of nestling Canada warblers. The treatment groups are: (A) No supplementation control, (B) low, (C) medium, (D) high, and (E) very high. The response variable is the weight of a ten-day-old nestling.

Create an R Markdown file to do the following:

1) Create an `R` chunk to load the data using:

```{r eval = FALSE}
library(FANR6750)
data("warblerWeight")
```

2) The researchers are interested in the following contrasts. Create a header called "Contrasts" and determine whether these contrasts are orthogonal. **Show your work!**

    + Groups A,B vs C,D,E  

    + Groups A vs B  

    + Groups C vs D,E  

    + Groups D vs E  

3) Create a header called "ANOVA analysis". Under this header, use the `warblerWeight` data to test the null hypothesis of each contrast. This section should include a well-formatted ANOVA table showing the results of the analysis. Use the `caption` argument in the `kable()` function to **include a brief caption** for the ANOVA table and the `round` argument to **print an appropriate number of digits**. 

4) In addition to the ANOVA table, compute and report, in a second table (with caption), the following for each contrast:

    + The difference in the means  

    + The SE of the difference in means  

    + The 95% CI for the difference in means  

5) Suppose you wanted to replicate the study with a smaller sample size of $n = 2$ per treatment group. In a new section called "Power analysis", calculate and report your power for this new experiment. This section should include both the `R` code you used to conduct the power analysis, and a brief (1-3 sentence) description of the result **and interpretation**. 

A few things to remember when creating the assignment:

- Be sure the output type is set to: `output: html_document`

- Title the document: `title: "Lab 4 assignment"`

- Be sure to include your first and last name in the `author` section 

- Be sure to set `echo = TRUE` in all `R` chunks so we can see both your code and the output

- Please upload both the `html` and `.Rmd` files when you submit your assignment  

- See the R Markdown reference sheet for help with creating `R` chunks, equations, tables, etc.



